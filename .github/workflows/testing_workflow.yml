name: testing_workflow

on:
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  config_monitoring:
    runs-on: ubuntu-latest
    steps:
          
      - uses: actions/checkout@v4   
      - name: copying files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          source: "alerts.yml,grafana_install.sh,postgres_exporter.env,prometheus.yml,prometheus_install.sh"
          target: /tmp/crc/

      - name: create alert file
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          run: |
            echo "switch to root"
            sudo su
            sudo cat > /tmp/crc_files/alertmanager.yml << EOF
            global:
              resolve_timeout: 1m

            route:
              group_by: ['alertname']
              group_wait: 10s
              group_interval: 10s
              repeat_interval: 1h
              receiver: 'email_notifications'
            receivers:
              - name: 'email_notifications'
              email_configs:
              - to: ${{ secrets.EMAIL_TO }}
                from: ${{ secrets.EMAIL_FROM }}
                smarthost: ${{ secrets.SMARTHOST }}
                auth_username: ${{ secrets.EMAIL_FROM }}
                auth_identity: ${{ secrets.EMAIL_FROM }}
                auth_password: ${{ secrets.EMAIL_PASS }}
                send_resolved: true  
            inhibit_rules:
              - source_match:
                  severity: 'critical'
            EOF


      # Runs a set of commands using the runners shell
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.
